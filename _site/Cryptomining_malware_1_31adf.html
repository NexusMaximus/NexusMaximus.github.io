<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Cryptomining Malware Sample Analysis 1: 31ADF | KyleTheReverser</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Cryptomining Malware Sample Analysis 1: 31ADF" />
<meta name="author" content="Kyle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I recently gained access to VirusShare and downloaded 65,536 samples (00353.zip, for those interested). Due to my inability to search the way I expected to be able to for specific kinds of samples on VirusShare’s website, I decided to download this massive corpus of malware and search for the samples I seek out within it. For my thesis, I need:" />
<meta property="og:description" content="I recently gained access to VirusShare and downloaded 65,536 samples (00353.zip, for those interested). Due to my inability to search the way I expected to be able to for specific kinds of samples on VirusShare’s website, I decided to download this massive corpus of malware and search for the samples I seek out within it. For my thesis, I need:" />
<link rel="canonical" href="http://localhost:4000/Cryptomining_malware_1_31adf" />
<meta property="og:url" content="http://localhost:4000/Cryptomining_malware_1_31adf" />
<meta property="og:site_name" content="KyleTheReverser" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-19T13:31:00-07:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@Kyle" />
<script type="application/ld+json">
{"description":"I recently gained access to VirusShare and downloaded 65,536 samples (00353.zip, for those interested). Due to my inability to search the way I expected to be able to for specific kinds of samples on VirusShare’s website, I decided to download this massive corpus of malware and search for the samples I seek out within it. For my thesis, I need:","author":{"@type":"Person","name":"Kyle"},"@type":"BlogPosting","url":"http://localhost:4000/Cryptomining_malware_1_31adf","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"},"name":"Kyle"},"headline":"Cryptomining Malware Sample Analysis 1: 31ADF","dateModified":"2019-02-19T13:31:00-07:00","datePublished":"2019-02-19T13:31:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Cryptomining_malware_1_31adf"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="http://localhost:4000/assets/images/favicon.ico" type="image/png" />

    <!-- Font Embed Code -->
    <link href="https://fonts.googleapis.com/css?family=Karla:400,400i,700,700i" rel="stylesheet" />

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">

</head>



<body class="layout-post">
    <div id="page" class="site">

        
        <header id="masthead" class="site-header outer">
    <div class="site-header-inside">
        <div class="site-branding">
            
                <p class="site-logo"><a href="/" rel="home"><img src="/assets/images/logo.png" alt="KyleTheReverser" /></a></p>
                <h1 class="site-title screen-reader-text"><a href="" rel="home"></a></h1>
            
        </div><!-- .site-branding -->
        <nav id="main-navigation" class="site-navigation" aria-label="Primary Navigation">
            <ul class="menu">
            
                <li class="menu-item"><a href="/about/">About</a></li>
            
            </ul>
            <button id="sidebar-show" class="sidebar-toggle"><span class="screen-reader-text">Open Sidebar</span><span class="icon-more" aria-hidden="true"></span></button>
        </nav><!-- .site-navigation -->
    </div><!-- .site-header-inside -->
</header><!-- .site-header -->
        

        <div id="content" class="site-content fadeInDown delay_075s">
    <main id="main" class="site-main outer">
        <article class="post-full inner">
            <header class="post-header">
                <div class="post-meta">
                    <time class="post-date" datetime="2019-02-19">February 19,
                        2019</time>
                </div><!-- .post-meta -->
                <h1 class="posttitle">Cryptomining Malware Sample Analysis 1: 31ADF</h1>
            </header><!-- .post-header -->
            
            <div class="post-content">
                <p>I recently gained access to VirusShare and downloaded 65,536 samples (00353.zip, for those interested). Due to my inability to search the way I expected to be able to for specific kinds of samples on VirusShare’s website, I decided to download this massive corpus of malware and search for the samples I seek out within it. For my thesis, I need:</p>

<ul>
  <li>Cryptomining malware <em>executable</em> assets/images/posts (i.e. not HTML scripts, which is what most of the malware in this corpus is)</li>
  <li>Banking trojans (emotets do the trick just fine)</li>
  <li>Ransomware (gandcrab, kryptik, etc)</li>
  <li>Maybe some adware</li>
</ul>

<p>Now, when we download the samples, we are given the assets/images/posts named in the format VirusShare_[md5sum of file here]. That’s it. We have no notion as to what kind of malware each file is. So, I wrote a python script that used VirusTotal’s api to obtain known information on the samples, and store it in a local database. I store this information, per sample, in the database:</p>

<ul>
  <li>file name</li>
  <li>file type (exe and kind of exe, html, word doc, pdf, etc)</li>
  <li>file hash (md5 or sha256)</li>
  <li>positives (i.e. how many antivirus vendors marked it as malicious)</li>
  <li>total (i.e. how many antivirus vendors have information on the file)</li>
  <li>results (i.e. the tags that antivirus vendors have assigned the file)</li>
</ul>

<p>Doing this enabled me to search the malware metainformation database for the kind of malware I need. My goals are to run through this malware and identify mining routines within it. Overall, I strive to find what differs and what doesn’t differ between these mining executables, in hopes that I’ll be able to augment a visualization tool with features that help identify when its analyzing a cryptomining sample, as opposed to some other kind of sample. More on that later.</p>

<p>My search in the SQL database turned up 30 or so different samples of all kinds of executable formats. We have PE32 EXEs, PE32+ EXEs (i.e. 64-bit portable executables), ELF 64-bit executables, and some Windows DLLs. The first one of interest to me is VirusShare_31ADFC123D1B85D3F0D43F8401DCD042.</p>

<p>First thing first: CFFExplorer.</p>

<p><img src="/assets/images/posts/31ADFsc/1_dowland.GIF" alt="CFFExplorer" /></p>

<p>“Dowland and Start.exe”. Nice. After a quick google search, I found that <a href="https://winworldpc.com/product/delphi/4x">Borland Delphi</a> is a development environment for Pascal, released in 1998.</p>

<p>Next up, the obligatory VT search:</p>

<p><img src="/assets/images/posts/31ADFsc/2_VT.PNG" alt="VT" /></p>

<p><img src="/assets/images/posts/31ADFsc/3_VT2.PNG" alt="VT2" /></p>

<p><img src="/assets/images/posts/31ADFsc/4_VT3.PNG" alt="VT3" /></p>

<p>It looks like a coinminer, and it also looks packed (as VT hints towards). Sadly, PEiD helps confirm this. Furthermore, after clicking a link in a comment from some dude on VT, I found that <a href="https://www.hybrid-analysis.com/sample/6a17224be680f1a51d28574b885e0ca54f4dc30af8d0004442cb6c806d2acb01?environmentId=120">hybrid-analysis</a> further confirms it’s Enigma– specifically, v1.1 (wow this dude is out of date).</p>

<p><img src="/assets/images/posts/31ADFsc/5_PEiD.PNG" alt="PEiD" /></p>

<p>Raw section sizes of 0 and virtual section sizes of &gt;0 are very suspicious. Opening it in Ida resulted in a notification that the Imports section is destroyed, which is further evidence that this thing is packed. However, Ida helped identify a potential saving grace:</p>

<p><img src="/assets/images/posts/31ADFsc/6_Ida.PNG" alt="6_Ida" /></p>

<p>All the jump instructions visible to Ida were to local locations, except for the very last one, which jumps to who knows where. This is very exciting because it means OllyDbg’s “find OEP by Section Hop” feature may work!</p>

<p>But sadly, it did not. Enigma protector appears to be powerful. My mentors haven’t played with Enigma and I can’t find any easily available unpacking tools. Guess it’s time to try manually unpacking my first live sample!</p>

<p>I will be using OllyDbg to debug this. If you haven’t seen my <a href="https://nexusmaximus.github.io/notes/2018/10/12/ch9_PMA_notes.html">posts on OllyDbg</a> or my <a href="https://nexusmaximus.github.io/notes/2018/10/15/ch18_PMA_notes.html">posts on unpacking</a>, check those out.</p>

<p>Upon opening this in OllyDbg (while also having it open in Ida), notice the similarities between instruction addresses.</p>

<p><img src="/assets/images/posts/31ADFsc/7_IdaInitial.PNG" alt="7_IdaAddress" /></p>

<p><img src="/assets/images/posts/31ADFsc/8_OllyInitial.PNG" alt="8_OllyInitial" /></p>

<p>Thankfully, Ida and Olly’s addresses line up (at least relative to the last byte). Ida registers the first instruction at 0x74cda6 and Olly registers the first instruction at 0x102cda6. The first interesting bit of code occurs at <strong>0xf388</strong>– our first XOR decode loop.</p>

<p><img src="/assets/images/posts/31ADFsc/9_decode1.PNG" alt="9_decode1" /></p>

<p>Note that this screenshot is after I have ran through one iteration of the loop. Things to notice:</p>

<ol>
  <li>We XOR the contents of where EAX points to, with DL, 1 byte at a time.</li>
  <li>ECX contains how many bytes we decode.</li>
  <li>Decoded code begins starting at Olly address 0x146f397.</li>
</ol>

<p>Before much has been decoded, notice the presence of garbage (as is indicated by processing the data as instructions and seeing that the instructions are .. meaningless):</p>

<p><img src="/assets/images/posts/31ADFsc/10_decode2.PNG" alt="10_decode2" /></p>

<p>After a few iterations, we see new instructions now exist.</p>

<p><img src="/assets/images/posts/31ADFsc/11_decode3.PNG" alt="11_decode3" /></p>

<p>One big giveaway that this is important and meaningful code is that it has jump instructions relative to the general area that this code is being decoded into.</p>

<p>So, I set a hardware breakpoint on the jmp immediately after the JNZ and noted the final address of this loop’s unpacked code: 0x146f94F. Range: 0x146f397-0x146f94f; however we jump to 0x146f39b. Luckily after two instructions, the disassembly in the top left window and in the bottom left window match back up; a sign that the dump is disassembling instructions properly (and is not offset by disassembling in the middle of an instruction).</p>

<p><img src="/assets/images/posts/31ADFsc/12_decode4.PNG" alt="12_decode4" /></p>

<p>Follow on through, not really positive exactly what’s happening but also not caring… and we arrive at decode loop 2. This one decodes 4 bytes at a time, and a lot more! Thank goodness.</p>

<p><img src="/assets/images/posts/31ADFsc/13_decodeloop2.PNG" alt="13_decodeloop2" /></p>

<p>Range of decode: 0x138e269-(0x138e269 + (ECX = 0x38426 * 4))</p>

<p><img src="/assets/images/posts/31ADFsc/14_predecode2.PNG" alt="14_predecode2" /></p>

<p>after some iterations…</p>

<p><img src="/assets/images/posts/31ADFsc/15_postdecode2.PNG" alt="15_postdecode2" /></p>

<p>Sketchy. So I decoded the rest of it and broke at the instruction immediately after.</p>

<p>0x138e269-0x146f301 is the value of this decode loop’s range. Still below the previous unpacking loop’s range; that code has not been overwritten.</p>

<p>Following it a little more… it jumps to 146f4aa which looks an awful lot like a generic function prelude.</p>

<p><img src="/assets/images/posts/31ADFsc/16_functionpreludemaybe.PNG" alt="16_funcprelude" /></p>

<p>After this, things kind of go awry. It gets much harder to follow. It is modifying 110e000 and onwards (to about 110f000). Then it looks like another phase begins.</p>

<p>I noticed that for the last few thousand instructions, EIP never left the range 146f400-146f650.</p>

<p>146f4ce-ish: an add that is probably checked</p>

<h4 id="notes">notes</h4>

<p>102cda6: start</p>

<p>0x110e000-0x110f000: mystery region. Not sure what’s happening but it’s being heavily modified by code in 146f400-146f650ish.</p>

<p>0x138e269-146f301: second unpacked region</p>

<p>0x146f397-146f94f: first unpacked region</p>


            </div>
            <footer class="post-footer">
                
                <div class="post-share">
                    <span class="post-share-title">Share:</span>
                    <a target="_blank" href="https://twitter.com/share?text=Cryptomining+Malware+Sample+Analysis+1%3A+31ADF&amp;url=https://nexusmaximus.github.ioCryptomining_malware_1_31adf">Twitter</a>
                    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://nexusmaximus.github.ioCryptomining_malware_1_31adf">Facebook</a>
                </div><!-- .share-post -->
            </footer>
            <div class="author-box">
                <div class="author-avatar"><img src="/assets/images/authorimage.jpg" alt="Kyle's Picture"
                        class="avatar"></div>
                <div class="author-details">
                    <h2 class="author-title">About Kyle</h2>
                    <p class="author-description">bio here</p>
                </div>
            </div>
            

        </article>
        
        <section class="read-next inner">
            <h2 class="read-next-title">Read Next</h2>
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="December 13, 2018">December 13, 2018</time>
                    </div>
                    <h3 class="post-title"><a href="/binary_instrumentation">Notes on Binary Instrumentation and Intel PIN</a></h3>
                    <p class="post-tags">
                        
                    </p>
                </header>
                
                
            </article>
            
            
        </section><!-- .read-next -->
    </main><!-- .site-main -->
</div><!-- .site-content -->

        

        

        <footer id="colophon" class="site-footer outer">
            <div class="site-footer-inside">
                <p class="social-links">
    
    <a href="https://twitter.com/KyleTheReverser" target="_blank">
        <span class="fa-twitter fa" aria-hidden="true"></span>
        <span class="screen-reader-text">Twitter</span>
    </a>
    
    
    
    <a href="https://github.com/NexusMaximus" target="_blank">
        <span class="fa-github fa" aria-hidden="true"></span>
        <span class="screen-reader-text">GitHub</span>
    </a>
    
    
    
    
    
    
    
    
</p>
                <p class="site-info">
                    <a href="#">KyleTheReverser</a> &copy; 2019 . Horace theme by
                    <a target="_blank" href="https://justgoodthemes.com/">JustGoodThemes</a>. <br />
                    Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
                </p>
                <p class="back-to-top">
                    <a id="top-button" class="top-button" href="#page">
                        <span class="icon-arrow-up" aria-hidden="true"></span>
                        <span class="screen-reader-text">Back to top</span>
                    </a>
                </p>
            </div><!-- .site-footer-inside -->
        </footer><!-- .site-footer -->
    </div><!-- .site -->
    <div id="site-overlay" class="site-overlay"></div>
    <aside id="sidebar" class="sidebar">
	<div class="sidebar-scrollable">
		<div class="sidebar-inside">
			<button id="sidebar-hide" class="sidebar-toggle"><span class="screen-reader-text">Close Sidebar</span><span
				    aria-hidden="true" class="icon-close"></span></button>
			<nav id="sidebar-navigation" class="widget site-navigation">
				<h2 class="widget-title">Explore Site</h2>
				<ul class="menu">
					
						<li class="menu-item"><a href="/about/">About</a></li>
					
				</ul>
			</nav>
			
<section class="widget widget-text">
    <h2 class="widget-title">About KyleTheReverser</h2>
    <p>This is an organized hub for everything technical that I write, set up, or figure out over the course of my last year as a Masters student.</p>
</section>


<section class="widget widget-recent-posts">
    <h2 class="widget-title">Recent Articles</h2>
    <ul>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">February 19, 2019</time>
                </div>
                <div class="post-title">
                    <a href="http://localhost:4000/Cryptomining_malware_1_31adf">Cryptomining Malware Sample Analysis 1: 31ADF</a>
                </div>
            </div>
            
            
        </li>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">December 13, 2018</time>
                </div>
                <div class="post-title">
                    <a href="http://localhost:4000/binary_instrumentation">Notes on Binary Instrumentation and Intel PIN</a>
                </div>
            </div>
            
            
        </li>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">November 10, 2018</time>
                </div>
                <div class="post-title">
                    <a href="http://localhost:4000/binary-code_obfs_paper_review">Paper review: Binary-Code Obfuscations in Prevalent Packer Tools</a>
                </div>
            </div>
            
            
        </li>
        
    </ul>
</section>

<!-- Create a sorted array of tags -->
 
<section class="widget widget-tagcloud">
    <h2 class="widget-title">Tags</h2>
    <div class="tagcloud">
        
        <a href='https://nexusmaximus.github.iotag/development/'>Development</a>
        
        <a href='https://nexusmaximus.github.iotag/javascript/'>JavaScript</a>
        
        <a href='https://nexusmaximus.github.iotag/jekyll/'>Jekyll</a>
        
        <a href='https://nexusmaximus.github.iotag/node/'>Node</a>
        
        <a href='https://nexusmaximus.github.iotag/startup/'>Startup</a>
        
        <a href='https://nexusmaximus.github.iotag/startups/'>Startups</a>
        
        <a href='https://nexusmaximus.github.iotag/tips/'>Tips</a>
        
    </div>
</section>


		</div><!-- .sidebar-inside -->
	</div><!-- .sidebar-scrollable -->
</aside><!-- .sidebar -->
    
    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>