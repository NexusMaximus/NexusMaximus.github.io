<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>PMA Ch.9 Notes: OllyDbg | KyleTheReverser</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="PMA Ch.9 Notes: OllyDbg" />
<meta name="author" content="Kyle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Chapter summary questions In two sentences or less, provide an overview of what this chapter is about." />
<meta property="og:description" content="Chapter summary questions In two sentences or less, provide an overview of what this chapter is about." />
<link rel="canonical" href="http://localhost:4000/ch9_PMA_notes" />
<meta property="og:url" content="http://localhost:4000/ch9_PMA_notes" />
<meta property="og:site_name" content="KyleTheReverser" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-10-12T14:31:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@Kyle" />
<script type="application/ld+json">
{"description":"Chapter summary questions In two sentences or less, provide an overview of what this chapter is about.","author":{"@type":"Person","name":"Kyle"},"@type":"BlogPosting","url":"http://localhost:4000/ch9_PMA_notes","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.png"},"name":"Kyle"},"headline":"PMA Ch.9 Notes: OllyDbg","dateModified":"2018-10-12T14:31:00-06:00","datePublished":"2018-10-12T14:31:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/ch9_PMA_notes"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="http://localhost:4000/assets/images/favicon.ico" type="image/png" />

    <!-- Font Embed Code -->
    <link href="https://fonts.googleapis.com/css?family=Karla:400,400i,700,700i" rel="stylesheet" />

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">

</head>



<body class="layout-post">
    <div id="page" class="site">

        
        <header id="masthead" class="site-header outer">
    <div class="site-header-inside">
        <div class="site-branding">
            
                <p class="site-logo"><a href="/" rel="home"><img src="/assets/images/logo.png" alt="KyleTheReverser" /></a></p>
                <h1 class="site-title screen-reader-text"><a href="" rel="home"></a></h1>
            
        </div><!-- .site-branding -->
        <nav id="main-navigation" class="site-navigation" aria-label="Primary Navigation">
            <ul class="menu">
            
                <li class="menu-item"><a href="/about">About</a></li>
            
            </ul>
            <button id="sidebar-show" class="sidebar-toggle"><span class="screen-reader-text">Open Sidebar</span><span class="icon-more" aria-hidden="true"></span></button>
        </nav><!-- .site-navigation -->
    </div><!-- .site-header-inside -->
</header><!-- .site-header -->
        

        <div id="content" class="site-content fadeInDown delay_075s">
    <main id="main" class="site-main outer">
        <article class="post-full inner">
            <header class="post-header">
                <div class="post-meta">
                    <time class="post-date" datetime="2018-10-12">October 12,
                        2018</time>
                </div><!-- .post-meta -->
                <h1 class="posttitle">PMA Ch.9 Notes: OllyDbg</h1>
            </header><!-- .post-header -->
            
            <div class="post-content">
                <h2 id="chapter-summary-questions">Chapter summary questions</h2>
<ol>
  <li>
    <p>In two sentences or less, provide an overview of what this chapter is about.</p>

    <p>This chapter covers how to use many features that OllyDbg provides.</p>
  </li>
  <li>
    <p>What are the three most important takeaways from this chapter?</p>

    <p>For this chapter, it’s hard to choose three <em>most</em> important takeaways, simply because all the information inside the chapter is helpful in some form of malware analysis scenario.</p>
  </li>
  <li>
    <p>What problems does this chapter address? In other words, why should we care about this chapter?</p>

    <p>We should care about this chapter as it gives us the introducton to one of the most powerful and popular tools in the malware analyst’s toolbox.</p>
  </li>
</ol>

<h2 id="using-ollydbg">Using OllyDbg</h2>

<h3 id="opening-a-file">Opening a file</h3>
<p>EZ. <strong>File -&gt; open.</strong> The only time in which you can pass in command line arguments is at this time.</p>

<p>You can also attach OllyDbg to a running process using <strong>File -&gt; attach</strong>. When you do this, OllyDbg will foist itself upon the running process and break all threads. It’ll display the current executing thread’s code. This may be windows API code, so you should have the program break upon access to the entire code section.</p>

<h3 id="understanding-ollys-gui">Understanding Olly’s GUI</h3>

<p><img src="/assets/images/posts/ch9sc/n1.PNG" alt="n1.PNG" /></p>

<p>Upon opening a program with OllyDbg (in my case, Lab09-01.exe), we have four different windows.</p>

<h4 id="top-left-the-disassembler-window">Top left: the disassembler window</h4>
<p>This is the disassember window. It shows the debugged program’s code– the current instruction pointer with several instructions before and after it. To modify instructions or data (or add new instructions), press spacebar within this window.</p>

<h4 id="top-right-registers-window">Top right: registers window</h4>
<p>You guessed it– it shows registers. They will change color as the program executes. Red is to highlight a recently changed value. You can right click any register value and select <strong>modify</strong> to change any register value.</p>

<h4 id="bottom-right-stack-window">Bottom right: stack window</h4>
<p>This shows the stack of the program. It’ll always show the top of the stack for a given thread. You can manipulate it in the same way as you can manipulate registers– right clicking a spot on the stack and selecting <strong>modify</strong>.</p>

<h4 id="bottom-left-memory-dump-window">Bottom left: memory dump window</h4>
<p>This window shows a dump of live memory for the debugged process. Pressing <strong>ctrl+G</strong> in this window permits you to go to a specific spot in memory. Clicking a memory address and selecting <strong>Follow in Dump</strong> permits you to dump tha tmemory address.</p>

<p>You can edit memory in this window, too. Right click some memory and choose <strong>Binary -&gt; edit</strong> to do so. This can be used to modify global variables and other data that malware stores in RAM.</p>

<h3 id="executing-code">Executing code</h3>

<p>See page 186 for a nice table on the hotkeys used to execute code. There are a few notable features worth mentioning:</p>
<ul>
  <li>When paused within library code, do a <strong>Debug -&gt; Execute until User Code</strong> to run until you’re no longer in the library.</li>
  <li>Step-into: F7.</li>
  <li>Step-over: F8</li>
</ul>

<h4 id="breakpoints">Breakpoints</h4>

<p>You can add or remove a breakpoin tby selecting the instruction in the disassembler window and pressing F2. You can view active breakpoints by selecting ** View -&gt; Breakpoints** or clicking the B icon in the toolbar.</p>

<p>You can generally select what breakpoints you want to use by right-clicking and going from <strong>Breakpoint -&gt; [breakpoint type here]</strong>. There are hotkeys for some of these too– see p188.</p>

<h3 id="buttons-and-other-windows">Buttons and other windows</h3>

<h4 id="memory-map-window-m">Memory map window (M)</h4>
<p>Click the M box or click <strong>View -&gt; Memory</strong> to display all memory blocks allocated by the debugged program. This is a great way to see how a program is laid out in memory. All DLLs and their code sections are also visible. You cna double-click any row in the memory map to show a memory dump of that section, or you can send the data in a memory dump to the disassembler window by right-clicking and selecting <strong>View in Disassembler.</strong> <strong>This seems very helpful for obfuscated malware.</strong></p>

<h3 id="dlls">DLLs</h3>
<p>OllyDbg can debug DLL assets/images/posts. Since DLLs cannot be executed directly, OllyDbg uses a dummy program called <em>loaddll.exe</em> to load them. By default, OllyDbg breaks at the DLL entry point (dllmain) when the DLL is loaded.</p>

<p>To call exported functions with arguments inside the debugged DLL:</p>
<ol>
  <li>Load the DLL</li>
  <li>Click the play button to run <code class="highlighter-rouge">DllMain</code> and any other intialization code the DLL requires</li>
  <li>Olly will pause, and you can call specific exports with arguments and debug them by selecting <strong>Debug -&gt; Call DLL Export</strong> from the main menu. (See an example of this on p191/p192.)</li>
</ol>

<h3 id="tracing">Tracing</h3>
<p><strong>Tracing</strong> is a powerful debugging technique that records detailed execution information for you to examine.</p>

<h4 id="standard-back-trace">Standard Back Trace</h4>
<p>Whenever you’re moving through the disassembler window with the Step Into and Step Over functions, OllyDbg is recording the movement. You can use the minus key on the keyboard to move back in time and see the instructions previously executed. The plus key takes you forward.</p>

<h4 id="call-stack">Call Stack</h4>
<p><strong>View -&gt; Call Stack</strong> will allow you to view the call stack. Imagine that.</p>

<p>To walk the call stack, click the Address or Called From sections of the call stack window. The registers and stack will not show you what was going on when in that location, unless you are performing a run trace.</p>

<h4 id="run-trace">Run Trace</h4>
<p>A <strong>run trace</strong> allows you to execute code and have OllyDbg save every executed instruction and all changes made to the registers and flags.</p>

<ul>
  <li>Highlight code you wish to trace. Select <strong>Run Trace -&gt; Add Selection</strong>. After, choose <strong>View -&gt; Run Trace</strong> to see the instructions. Use the + and - keys as discussed above to run through the trace.</li>
  <li>You can also use the <strong>Trace Into</strong> and <strong>Trace Over</strong> options. These will simply trace until a breakpoint is hit.</li>
</ul>

<h3 id="patching">Patching</h3>
<p>You can modify instructions or memory by highlighting a region, right-clicking the region, and selecting <strong>Binary -&gt; Edit</strong>. This just changes the live memory; to take patching a step further and saving the on-disk executable, right click the disassembler window wher eyou patched the code and select <strong>Copy to Executable-&gt;All Modifications</strong>, and then select <strong>Save file</strong>.</p>

<h3 id="analyzing-shellcode-or-other-random-instructions">Analyzing shellcode (or other random instructions)</h3>

<p>See the step by step process on p196. All I would do in these notes is copy that ordered list of instructions, more or less otherwise.</p>

<h2 id="rebasing">Rebasing</h2>
<p>This occurs when a module in Windows is not loaded at its preferred <em>base address.</em> All PE assets/images/posts in Windows have a preferred base address, known as the <em>image base</em> defined in the PE header. Most executables are designed to be loaded at <code class="highlighter-rouge">0x400000</code>, which is probably why so many variables and functions in Ida are named using 0x400000 or some close number in some fashion.</p>

<p>Of course, this is a preferred address, but it doesn’t guarantee a program will be loaded there. For example, if a program has two DLLs and they each have the same base address, they can’t both be loaded at the same address.</p>

<p>Some instructions rely on the data being loaded at a specifc address, such as this instruction:</p>

<p><code class="highlighter-rouge">mov eax, dword__40CF60</code></p>

<p>That won’t work if the DLL with that instruction isn’t loaded in the right spot due to the use of an absolute address. Most DLLs come packaged with a list of fix-up locations in the <code class="highlighter-rouge">.reloc</code> section of the PE header.</p>

<p>DLLs are loaded after the .exe and are loaded in any order, meaning you can’t generally predict where DLLs will be located in memory if they’re rebased. If a DLL lacking a relocation section can’t be loaded at its preferred base address, then it cannot be loaded.</p>

<h2 id="wrapping-up">Wrapping up</h2>

<p>Assistance features– p197</p>
<ul>
  <li>Logging</li>
  <li>Watches window (i.e. watching when certain things change)</li>
  <li>Help</li>
  <li>Labelling
    <ul>
      <li>right click an address and select <strong>Label</strong> which will prop up a window, promting for a label name. Works like in Ida.</li>
    </ul>
  </li>
</ul>

<p>How to use plugins– p197</p>

<p>Scriptable debugging – using Python to do plugins.</p>


            </div>
            <footer class="post-footer">
                
                <div class="post-share">
                    <span class="post-share-title">Share:</span>
                    <a target="_blank" href="https://twitter.com/share?text=PMA+Ch.9+Notes%3A+OllyDbg&amp;url=https://nexusmaximus.github.ioch9_PMA_notes">Twitter</a>
                    <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://nexusmaximus.github.ioch9_PMA_notes">Facebook</a>
                </div><!-- .share-post -->
            </footer>
            <div class="author-box">
                <div class="author-avatar"><img src="/assets/images/authorimage.jpg" alt="Kyle's Picture"
                        class="avatar"></div>
                <div class="author-details">
                    <h2 class="author-title">About Kyle</h2>
                    <p class="author-description">bio here</p>
                </div>
            </div>
            

        </article>
        
        <section class="read-next inner">
            <h2 class="read-next-title">Read Next</h2>
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="October 7, 2018">October 7, 2018</time>
                    </div>
                    <h3 class="post-title"><a href="/PMA_ch8_notes">PMA Ch8 Notes: Debuggers</a></h3>
                    <p class="post-tags">
                        
                    </p>
                </header>
                
                
            </article>
            
            
            <article class="post">
                <header class="post-header">
                    <div class="post-meta">
                        <time class="published" datetime="October 12, 2018">October 12, 2018</time>
                    </div>
                    <h3 class="post-title"><a href="/PMA_ch9_labs">PMA Ch9 Lab: Using OllyDbg</a></h3>
                    <p class="post-tags">
                        
                    </p>
                </header>
                
                
            </article>
            
        </section><!-- .read-next -->
    </main><!-- .site-main -->
</div><!-- .site-content -->

        

        

        <footer id="colophon" class="site-footer outer">
            <div class="site-footer-inside">
                <p class="social-links">
    
    <a href="https://twitter.com/KyleTheReverser" target="_blank">
        <span class="fa-twitter fa" aria-hidden="true"></span>
        <span class="screen-reader-text">Twitter</span>
    </a>
    
    
    
    <a href="https://github.com/NexusMaximus" target="_blank">
        <span class="fa-github fa" aria-hidden="true"></span>
        <span class="screen-reader-text">GitHub</span>
    </a>
    
    
    
    
    
    
    
    
</p>
                <p class="site-info">
                    <a href="#">KyleTheReverser</a> &copy; 2019 . Horace theme by
                    <a target="_blank" href="https://justgoodthemes.com/">JustGoodThemes</a>. <br />
                    Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
                </p>
                <p class="back-to-top">
                    <a id="top-button" class="top-button" href="#page">
                        <span class="icon-arrow-up" aria-hidden="true"></span>
                        <span class="screen-reader-text">Back to top</span>
                    </a>
                </p>
            </div><!-- .site-footer-inside -->
        </footer><!-- .site-footer -->
    </div><!-- .site -->
    <div id="site-overlay" class="site-overlay"></div>
    <aside id="sidebar" class="sidebar">
	<div class="sidebar-scrollable">
		<div class="sidebar-inside">
			<button id="sidebar-hide" class="sidebar-toggle"><span class="screen-reader-text">Close Sidebar</span><span
				    aria-hidden="true" class="icon-close"></span></button>
			<nav id="sidebar-navigation" class="widget site-navigation">
				<h2 class="widget-title">Explore Site</h2>
				<ul class="menu">
					
						<li class="menu-item"><a href="/about">About</a></li>
					
				</ul>
			</nav>
			
<section class="widget widget-text">
    <h2 class="widget-title">About KyleTheReverser</h2>
    <p>This is an organized hub for everything technical that I write, set up, or figure out over the course of my last year as a Masters student.</p>
</section>


<section class="widget widget-recent-posts">
    <h2 class="widget-title">Recent Articles</h2>
    <ul>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">March 2, 2019</time>
                </div>
                <div class="post-title">
                    <a href="http://localhost:4000/PE_FF_Exploration">Exploring How Packers Mangle Files While Sticking to the PE Format</a>
                </div>
            </div>
            
            
        </li>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">February 19, 2019</time>
                </div>
                <div class="post-title">
                    <a href="http://localhost:4000/Cryptomining_malware_1_31adf">Cryptomining Malware Sample Analysis 1: 31ADF</a>
                </div>
            </div>
            
            
        </li>
        
        <li>
            <div class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="??">December 13, 2018</time>
                </div>
                <div class="post-title">
                    <a href="http://localhost:4000/binary_instrumentation">Notes on Binary Instrumentation and Intel PIN</a>
                </div>
            </div>
            
            
        </li>
        
    </ul>
</section>

<!-- Create a sorted array of tags -->
 
<section class="widget widget-tagcloud">
    <h2 class="widget-title">Tags</h2>
    <div class="tagcloud">
        
        <a href='https://nexusmaximus.github.iotag/development/'>Development</a>
        
        <a href='https://nexusmaximus.github.iotag/javascript/'>JavaScript</a>
        
        <a href='https://nexusmaximus.github.iotag/jekyll/'>Jekyll</a>
        
        <a href='https://nexusmaximus.github.iotag/node/'>Node</a>
        
        <a href='https://nexusmaximus.github.iotag/startup/'>Startup</a>
        
        <a href='https://nexusmaximus.github.iotag/startups/'>Startups</a>
        
        <a href='https://nexusmaximus.github.iotag/tips/'>Tips</a>
        
    </div>
</section>


		</div><!-- .sidebar-inside -->
	</div><!-- .sidebar-scrollable -->
</aside><!-- .sidebar -->
    
    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>